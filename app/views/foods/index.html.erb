<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SumLife</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap');
    
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    :root {
      --primary: #6366f1;
      --primary-dark: #4f46e5;
      --primary-light: #818cf8;
      --success: #10b981;
      --danger: #ef4444;
      --warning: #f59e0b;
      --gray-50: #f9fafb;
      --gray-100: #f3f4f6;
      --gray-200: #e5e7eb;
      --gray-300: #d1d5db;
      --gray-400: #9ca3af;
      --gray-500: #6b7280;
      --gray-600: #4b5563;
      --gray-700: #374151;
      --gray-800: #1f2937;
      --gray-900: #111827;
      --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
      --shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
      --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
      --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
      --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
    }

    html {
      scroll-behavior: smooth;
    }

    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f093fb 100%);
      background-attachment: fixed;
      min-height: 100vh;
      padding: 8px;
      color: var(--gray-900);
    }

    #form-section {
      scroll-margin-top: 20px;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
      border-radius: 16px;
      box-shadow: var(--shadow-xl);
      padding: 24px;
    }

    .header {
      text-align: center;
      margin-bottom: 24px;
      position: relative;
      padding-top: 40px;
      min-height: 100px;
    }

    .user-info {
      position: absolute;
      top: 0;
      right: 0;
      display: flex;
      align-items: center;
      gap: 12px;
      flex-wrap: wrap;
      justify-content: flex-end;
      max-width: 50%;
    }

    .user-email {
      color: var(--gray-700);
      font-size: 0.875rem;
      font-weight: 500;
      text-decoration: none;
      background: var(--gray-200);
      padding: 6px 12px;
      border-radius: 6px;
      border: 1px solid var(--gray-300);
      transition: all 0.2s ease;
      display: inline-block;
      cursor: pointer;
      max-width: 200px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .user-email:hover {
      background: var(--primary);
      color: white;
      border-color: var(--primary);
      text-decoration: none;
      transform: translateY(-1px);
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }
    }

    .logout-btn,
    .logout-btn input[type="submit"],
    form[action*="logout"] input[type="submit"] {
      background: var(--gray-200) !important;
      color: var(--gray-700) !important;
      border: none !important;
      padding: 4px 10px !important;
      border-radius: 6px !important;
      font-size: 0.6875rem !important;
      font-weight: 500 !important;
      cursor: pointer;
      transition: all 0.2s ease;
      text-decoration: none;
      display: inline-block;
      font-family: inherit;
      white-space: nowrap;
      line-height: 1.2;
      min-height: auto;
      height: auto;
    }

    .logout-btn:hover,
    .logout-btn input[type="submit"]:hover,
    form[action*="logout"] input[type="submit"]:hover {
      background: var(--gray-300) !important;
      transform: translateY(-1px);
    }

    form[action*="logout"] {
      display: inline;
      margin: 0;
      padding: 0;
    }

    .header h1 {
      font-size: 3rem;
      font-weight: 800;
      background: linear-gradient(135deg, var(--primary) 0%, #764ba2 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      margin-bottom: 8px;
      letter-spacing: -0.02em;
      margin-top: 0;
    }

    .header .subtitle {
      color: var(--gray-600);
      font-size: 1.125rem;
      font-weight: 400;
    }

    .date-navigation {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 12px;
      margin-bottom: 24px;
      padding: 16px;
      background: rgba(255, 255, 255, 0.6);
      border-radius: 12px;
      backdrop-filter: blur(10px);
    }

    .date-nav-btn {
      background: var(--primary);
      color: white;
      border: none;
      padding: 10px 16px;
      border-radius: 8px;
      text-decoration: none;
      font-weight: 600;
      transition: all 0.2s;
      cursor: pointer;
    }

    .date-nav-btn:hover {
      background: var(--primary-dark);
      transform: translateY(-1px);
    }

    .date-input {
      padding: 10px 16px;
      border: 2px solid var(--gray-200);
      border-radius: 8px;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
    }

    .date-today-btn {
      background: var(--gray-200);
      color: var(--gray-700);
      padding: 10px 20px;
      border-radius: 8px;
      text-decoration: none;
      font-weight: 600;
      font-size: 0.875rem;
      transition: all 0.2s;
    }

    .date-today-btn:hover {
      background: var(--gray-300);
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
      gap: 12px;
      margin-bottom: 16px;
    }

    .stat-card {
      background: white;
      padding: 16px;
      border-radius: 10px;
      box-shadow: var(--shadow);
      text-align: center;
      border: 1px solid var(--gray-200);
      min-width: 0;
      overflow: hidden;
      word-wrap: break-word;
    }

    .stat-card.health-score {
      background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
      color: white;
      grid-column: span 2;
    }

    .stat-label {
      font-size: 0.75rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      opacity: 0.8;
      margin-bottom: 8px;
    }

    .stat-value {
      font-size: 2rem;
      font-weight: 800;
      line-height: 1;
      margin-bottom: 4px;
      word-break: break-word;
      overflow-wrap: break-word;
    }

    .total-calories-stat .stat-value,
    .total-calories-value {
      font-size: 1.5rem;
      font-weight: 700;
    }

    .health-score-value {
      font-size: 3rem;
    }

    .stat-subtitle {
      font-size: 0.875rem;
      opacity: 0.9;
    }

    .charts-section {
      background: white;
      padding: 16px;
      border-radius: 12px;
      box-shadow: var(--shadow);
      border: 1px solid var(--gray-200);
      height: fit-content;
      position: sticky;
      top: 10px;
      display: flex;
      flex-direction: column;
    }

    .charts-section h3 {
      font-size: 1rem;
      font-weight: 700;
      margin-bottom: 12px;
      color: var(--gray-900);
    }

    .charts-grid {
      display: flex;
      flex-direction: column;
      gap: 20px;
    }

    .chart-container {
      position: relative;
      height: 160px;
    }

    .total-calories-card {
      background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
      color: white;
      padding: 32px;
      border-radius: 16px;
      text-align: center;
      margin-bottom: 32px;
      box-shadow: var(--shadow-lg);
      position: relative;
      overflow: hidden;
    }


    .total-calories-label {
      font-size: 0.875rem;
      font-weight: 500;
      opacity: 0.9;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      margin-bottom: 8px;
    }

    .total-calories-value {
      font-size: 3rem;
      font-weight: 700;
      position: relative;
      z-index: 1;
    }

    .message {
      color: white;
      padding: 16px 20px;
      border-radius: 12px;
      margin-bottom: 24px;
      text-align: center;
      font-weight: 500;
      box-shadow: var(--shadow-md);
      animation: slideDown 0.3s ease-out;
      position: relative;
      z-index: 1;
    }

    @keyframes slideDown {
      from {
        opacity: 0;
        transform: translateY(-10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .message.success {
      background: linear-gradient(135deg, var(--success) 0%, #059669 100%);
    }

    .message.delete {
      background: linear-gradient(135deg, var(--danger) 0%, #dc2626 100%);
    }

    .message.error {
      background: linear-gradient(135deg, var(--warning) 0%, #d97706 100%);
    }

    .main-content {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px;
      margin-top: 16px;
    }

    .main-content-with-charts {
      display: grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap: 16px;
      margin-top: 16px;
    }

    .form-section {
      background: var(--gray-50);
      padding: 20px;
      border-radius: 12px;
      border: 1px solid var(--gray-200);
      height: fit-content;
      position: sticky;
      top: 10px;
    }

    .form-section h2 {
      font-size: 1.25rem;
      font-weight: 700;
      color: var(--gray-900);
      margin-bottom: 16px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .form-group {
      margin-bottom: 12px;
    }

    .quantity-group {
      margin-bottom: 12px;
    }

    .quantity-input-wrapper {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .quantity-input {
      flex: 1;
      max-width: 150px;
    }

    .quantity-unit {
      color: var(--gray-600);
      font-size: 0.875rem;
      font-weight: 600;
      white-space: nowrap;
    }

    .quantity-unit-select {
      padding: 8px 12px;
      border: 2px solid var(--gray-200);
      border-radius: 8px;
      font-size: 0.875rem;
      font-weight: 600;
      color: var(--gray-700);
      background: white;
      cursor: pointer;
      transition: all 0.2s ease;
      font-family: inherit;
      min-width: 100px;
    }

    .quantity-unit-select:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
    }

    .quantity-unit-select:hover {
      border-color: var(--gray-300);
    }

    .nutritional-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 10px;
    }

    .nutritional-grid .form-group {
      margin-bottom: 12px;
    }

    label {
      display: block;
      margin-bottom: 4px;
      color: var(--gray-700);
      font-weight: 600;
      font-size: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    input[type="text"],
    input[type="number"] {
      width: 100%;
      padding: 10px 12px;
      border: 2px solid var(--gray-200);
      border-radius: 8px;
      font-size: 0.9375rem;
      transition: all 0.2s ease;
      background: white;
      font-family: inherit;
    }

    input[type="text"]:focus,
    input[type="number"]:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
      transform: translateY(-1px);
    }

    .food-search-container {
      position: relative;
      margin-bottom: 8px;
    }

    .helper-text {
      font-size: 0.6875rem;
      color: var(--gray-500);
      margin-top: 4px;
      display: flex;
      align-items: center;
      gap: 4px;
    }

    button[type="submit"],
    .add-button {
      background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
      color: white;
      border: none;
      padding: 14px 32px;
      border-radius: 10px;
      font-size: 1rem;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      box-shadow: var(--shadow-lg);
      font-family: inherit;
      width: 100%;
      margin-top: 12px;
      clear: both;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      position: relative;
      overflow: hidden;
      letter-spacing: 0.02em;
      text-transform: uppercase;
      min-height: 48px;
    }

    button[type="submit"]::before,
    .add-button::before {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      width: 0;
      height: 0;
      border-radius: 50%;
      background: rgba(255, 255, 255, 0.25);
      transform: translate(-50%, -50%);
      transition: width 0.6s, height 0.6s;
    }

    button[type="submit"]:hover::before,
    .add-button:hover::before {
      width: 400px;
      height: 400px;
    }

    button[type="submit"]:hover,
    .add-button:hover {
      transform: translateY(-3px);
      box-shadow: 0 20px 25px -5px rgba(99, 102, 241, 0.3), 0 10px 10px -5px rgba(99, 102, 241, 0.2);
      background: linear-gradient(135deg, var(--primary-light) 0%, var(--primary) 100%);
    }

    button[type="submit"]:active,
    .add-button:active {
      transform: translateY(-1px);
      box-shadow: var(--shadow-md);
    }

    button[type="submit"]:focus,
    .add-button:focus {
      outline: none;
      box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.2), var(--shadow-lg);
    }

    .food-list {
      background: var(--gray-50);
      padding: 20px;
      border-radius: 12px;
      border: 1px solid var(--gray-200);
      max-height: 600px;
      overflow-y: auto;
      min-height: 200px;
    }

    .food-list::-webkit-scrollbar {
      width: 8px;
    }

    .food-list::-webkit-scrollbar-track {
      background: var(--gray-100);
      border-radius: 4px;
    }

    .food-list::-webkit-scrollbar-thumb {
      background: var(--gray-400);
      border-radius: 4px;
    }

    .food-list::-webkit-scrollbar-thumb:hover {
      background: var(--gray-500);
    }

    .food-list h2 {
      font-size: 1.25rem;
      font-weight: 700;
      color: var(--gray-900);
      margin-bottom: 16px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .food-item {
      background: white;
      border: 1px solid var(--gray-200);
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 12px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 16px;
      transition: all 0.2s ease;
      box-shadow: var(--shadow-sm);
    }

    .food-item:hover {
      border-color: var(--primary-light);
      box-shadow: var(--shadow-md);
      transform: translateY(-2px);
    }

    .food-info {
      flex: 1;
    }

    .food-name {
      font-weight: 600;
      color: var(--gray-900);
      font-size: 1.125rem;
      margin-bottom: 4px;
    }

    .food-calories {
      color: var(--gray-500);
      font-size: 0.875rem;
      font-weight: 500;
    }

    .food-details {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .food-macros {
      color: var(--gray-500);
      font-size: 0.75rem;
      font-weight: 500;
    }

    .food-actions {
      display: flex;
      gap: 8px;
      align-items: center;
      flex-shrink: 0;
    }

    .edit-btn {
      width: 40px !important;
      min-width: 40px !important;
      max-width: 40px !important;
      height: 40px !important;
      padding: 0 !important;
      margin: 0 !important;
      border-radius: 8px;
      font-size: 1.125rem;
      font-weight: 400;
      cursor: pointer;
      transition: all 0.2s ease;
      box-shadow: var(--shadow-sm);
      font-family: inherit;
      flex-shrink: 0;
      white-space: nowrap;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      border: 1px solid var(--gray-300);
      box-sizing: border-box;
      background: white;
      color: var(--gray-700);
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .edit-btn:hover {
      transform: translateY(-1px);
      box-shadow: var(--shadow-md);
      background: var(--gray-50);
      border-color: var(--gray-400);
    }

    /* Delete button - plain button with icon */
    .delete-btn {
      width: 40px;
      min-width: 40px;
      max-width: 40px;
      height: 40px;
      padding: 0;
      margin: 0;
      border-radius: 8px;
      font-size: 1.125rem;
      font-weight: 400;
      cursor: pointer;
      transition: all 0.2s ease;
      box-shadow: var(--shadow-sm);
      font-family: inherit;
      flex-shrink: 0;
      white-space: nowrap;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      border: 1px solid rgba(239, 68, 68, 0.3);
      box-sizing: border-box;
      background: rgba(239, 68, 68, 1);
      background-color: rgba(239, 68, 68, 1);
      background-image: none;
      color: white;
      overflow: hidden;
      vertical-align: top;
      line-height: 1;
    }

    .delete-btn:hover {
      transform: translateY(-1px);
      box-shadow: var(--shadow-md);
      background: rgba(220, 38, 38, 1);
      background-color: rgba(220, 38, 38, 1);
      background-image: none;
      border-color: rgba(220, 38, 38, 0.5);
    }

    .delete-btn:active {
      transform: translateY(0);
    }

    /* Modal Styles */
    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      overflow: auto;
      background-color: rgba(0, 0, 0, 0.5);
      backdrop-filter: blur(4px);
      animation: fadeIn 0.2s ease;
    }

    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    .modal-content {
      background-color: white;
      margin: 5% auto;
      padding: 0;
      border-radius: 16px;
      width: 90%;
      max-width: 600px;
      box-shadow: var(--shadow-xl);
      animation: slideDown 0.3s ease;
      max-height: 90vh;
      overflow-y: auto;
    }

    @keyframes slideDown {
      from {
        transform: translateY(-50px);
        opacity: 0;
      }
      to {
        transform: translateY(0);
        opacity: 1;
      }
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 24px;
      border-bottom: 1px solid var(--gray-200);
    }

    .modal-header h2 {
      margin: 0;
      font-size: 1.5rem;
      color: var(--gray-800);
    }

    .modal-close {
      background: none;
      border: none;
      font-size: 2rem;
      color: var(--gray-500);
      cursor: pointer;
      padding: 0;
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
      transition: all 0.2s ease;
    }

    .modal-close:hover {
      background: var(--gray-100);
      color: var(--gray-700);
    }

    .modal-content .form-section {
      padding: 24px;
      border: none;
      box-shadow: none;
      margin: 0;
    }

    .modal-content .form-group {
      margin-bottom: 16px;
    }

    .modal-content .nutritional-grid {
      gap: 12px;
    }

    .form-actions {
      display: flex;
      gap: 12px;
      margin-top: 12px;
    }

    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: var(--gray-400);
    }

    .empty-state-icon {
      font-size: 4rem;
      margin-bottom: 16px;
      opacity: 0.5;
    }

    .empty-state-text {
      font-size: 1.125rem;
      font-weight: 500;
    }

    .food-suggestions {
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      background: white;
      border: 2px solid var(--gray-200);
      border-radius: 12px;
      max-height: 240px;
      overflow-y: auto;
      z-index: 1000;
      box-shadow: var(--shadow-xl);
      display: none;
      margin-top: 4px;
    }

    .food-suggestions.loading {
      display: block;
      padding: 20px;
      text-align: center;
    }

    .search-loader {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid var(--gray-200);
      border-top-color: var(--primary);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
      margin-right: 8px;
      vertical-align: middle;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .search-loading-text {
      color: var(--gray-600);
      font-size: 0.875rem;
      display: inline-flex;
      align-items: center;
    }

    .no-results-message {
      padding: 20px 16px;
      text-align: center;
      color: var(--gray-500);
      font-size: 0.875rem;
      font-style: italic;
    }

    .food-suggestion-item {
      padding: 14px 16px;
      cursor: pointer;
      border-bottom: 1px solid var(--gray-100);
      transition: all 0.15s ease;
    }

    .food-suggestion-item:first-child {
      border-radius: 12px 12px 0 0;
    }

    .food-suggestion-item:last-child {
      border-bottom: none;
      border-radius: 0 0 12px 12px;
    }

    .food-suggestion-item:hover {
      background: var(--gray-50);
      padding-left: 20px;
    }

    .food-suggestion-name {
      font-weight: 600;
      color: var(--gray-900);
      font-size: 0.9375rem;
    }

    .food-suggestion-details {
      font-size: 0.8125rem;
      color: var(--gray-500);
      margin-top: 4px;
    }

    @media (max-width: 640px) {
      .container {
        padding: 24px;
        border-radius: 16px;
      }

      .header {
        padding-top: 60px;
        min-height: 140px;
      }

      .header h1 {
        font-size: 2rem;
      }

      .user-info {
        max-width: 100%;
        justify-content: center;
        left: 0;
        right: 0;
      }

      .user-email {
        max-width: 150px;
        font-size: 0.75rem;
      }

      .logout-btn {
        padding: 4px 10px;
        font-size: 0.6875rem;
      }

      .total-calories-stat .stat-value,
      .total-calories-value {
        font-size: 1.25rem;
      }
      
      .stats-grid {
        grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
      }

      .main-content,
      .main-content-with-charts {
        grid-template-columns: 1fr;
      }

      .charts-section {
        position: static;
      }

      .form-section {
        padding: 20px;
        position: static;
      }


      .food-list {
        padding: 20px;
      }

      .charts-section {
        margin-top: 24px;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <div class="user-info">
        <%= link_to current_user.email, profile_path, class: "user-email profile-link" %>
        <%= button_to "Logout", logout_path, method: :delete, class: "logout-btn", form: { style: "display: inline;" } %>
      </div>
      <h1>üçé SumLife</h1>
      <p class="subtitle">Track your daily nutrition with ease</p>
    </div>

    <!-- Date Navigation -->
    <div class="date-navigation">
      <% if @selected_date > @earliest_date %>
        <%= link_to "‚Üê", root_path(date: (@selected_date - 1.day)), class: "date-nav-btn", title: "Previous day" %>
      <% else %>
        <span class="date-nav-btn" style="opacity: 0.3; cursor: not-allowed;">‚Üê</span>
      <% end %>
      <input type="date" id="date-picker" value="<%= @selected_date %>" class="date-input" 
             min="<%= @earliest_date %>" max="<%= [@latest_date, Date.current].max %>">
      <% if @selected_date < [@latest_date, Date.current].max %>
        <%= link_to "‚Üí", root_path(date: (@selected_date + 1.day)), class: "date-nav-btn", title: "Next day" %>
      <% else %>
        <span class="date-nav-btn" style="opacity: 0.3; cursor: not-allowed;">‚Üí</span>
      <% end %>
      <% if @selected_date != Date.current %>
        <%= link_to "Today", root_path, class: "date-today-btn" %>
      <% end %>
    </div>

    <!-- Health Score and Totals -->
    <div class="stats-grid">
      <div class="stat-card health-score">
        <div class="stat-label">Health Score</div>
        <div class="stat-value health-score-value" data-score="<%= @health_score %>">
          <%= @health_score %>
        </div>
        <div class="stat-subtitle">out of 100</div>
      </div>
      <div class="stat-card total-calories-stat">
        <div class="stat-label">Total Calories</div>
        <div class="stat-value total-calories-value">
          <%= @nutritional_totals[:calories].to_i %><% if @recommended_calories %>/<%= @recommended_calories %><% end %>
        </div>
        <% if @recommended_calories %>
          <div class="stat-subtitle">
            <% percentage = (@nutritional_totals[:calories] / @recommended_calories.to_f * 100).round(1) %>
            <%= percentage %>% of daily goal
          </div>
        <% end %>
      </div>
      <div class="stat-card">
        <div class="stat-label">Protein</div>
        <div class="stat-value"><%= @nutritional_totals[:protein].round(1) %>g</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Carbs</div>
        <div class="stat-value"><%= @nutritional_totals[:carbs].round(1) %>g</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Fat</div>
        <div class="stat-value"><%= @nutritional_totals[:fat].round(1) %>g</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Fiber</div>
        <div class="stat-value"><%= @nutritional_totals[:fiber].round(1) %>g</div>
      </div>
    </div>

    <% if @message %>
      <div class="message <%= @message_type || 'success' %>">
        <%= @message %>
      </div>
    <% end %>

    <div class="main-content<%= ' main-content-with-charts' if @nutritional_totals[:calories] > 0 %>">
      <div class="form-section" id="form-section">
      <h2>‚ûï Add Food Entry</h2>
      <%= form_with url: foods_path, method: :post, local: true, id: "add-food-form" do |form| %>
        <%= form.hidden_field :date, value: @selected_date %>
        <%= form.hidden_field :quantity, id: "form-quantity", value: 1 %>
        <%= form.hidden_field :unit, id: "form-unit", value: "serving" %>
        <div class="form-group">
          <%= form.label :name, "Food Name" %>
          <div class="food-search-container">
            <%= form.text_field :name, id: "name", placeholder: "Search or type a food name...", required: true, autocomplete: "off" %>
            <div id="food-suggestions" class="food-suggestions"></div>
          </div>
          <div class="helper-text">üí° Start typing to search from our food database</div>
        </div>
        <div class="form-group quantity-group">
          <%= form.label :quantity, "Quantity/Amount" %>
          <div class="quantity-input-wrapper">
            <%= form.number_field :quantity, id: "quantity", placeholder: "1", min: 0.1, step: 0.1, value: 1, class: "quantity-input" %>
            <select id="quantity-unit-select" class="quantity-unit-select">
              <option value="serving">serving(s)</option>
              <option value="g">g</option>
              <option value="ml">ml</option>
            </select>
          </div>
          <div class="helper-text" id="base-serving-info">Base: 1 serving</div>
        </div>
        <div class="nutritional-grid">
          <div class="form-group">
            <%= form.label :calories, "Calories" %>
            <%= form.number_field :calories, id: "calories", placeholder: "0", min: 0, step: 0.1, required: true %>
          </div>
          <div class="form-group">
            <%= form.label :protein, "Protein (g)" %>
            <%= form.number_field :protein, id: "protein", placeholder: "0", min: 0, step: 0.1, value: 0 %>
          </div>
          <div class="form-group">
            <%= form.label :carbs, "Carbs (g)" %>
            <%= form.number_field :carbs, id: "carbs", placeholder: "0", min: 0, step: 0.1, value: 0 %>
          </div>
          <div class="form-group">
            <%= form.label :fat, "Fat (g)" %>
            <%= form.number_field :fat, id: "fat", placeholder: "0", min: 0, step: 0.1, value: 0 %>
          </div>
          <div class="form-group">
            <%= form.label :fiber, "Fiber (g)" %>
            <%= form.number_field :fiber, id: "fiber", placeholder: "0", min: 0, step: 0.1, value: 0 %>
          </div>
          <div class="form-group">
            <%= form.label :sugar, "Sugar (g)" %>
            <%= form.number_field :sugar, id: "sugar", placeholder: "0", min: 0, step: 0.1, value: 0 %>
          </div>
          <div class="form-group">
            <%= form.label :sodium, "Sodium (mg)" %>
            <%= form.number_field :sodium, id: "sodium", placeholder: "0", min: 0, step: 0.1, value: 0 %>
          </div>
        </div>
        <%= form.submit "‚ûï Add", class: "add-button", id: "add-food-submit" %>
      <% end %>
      </div>

      <div class="food-list">
        <h2>üìã Foods for <%= @selected_date.strftime("%B %d, %Y") %></h2>
        <% if @foods.empty? %>
          <div class="empty-state">
            <div class="empty-state-icon">üçΩÔ∏è</div>
            <div class="empty-state-text">No foods added yet.<br>Add your first food above!</div>
          </div>
        <% else %>
          <% @foods.each do |food| %>
            <div class="food-item">
              <div class="food-info">
                <div class="food-name"><%= food.name %></div>
                <div class="food-details">
                  <span class="food-calories"><%= food.calories.round %> cal</span>
                  <% if food.protein > 0 || food.carbs > 0 || food.fat > 0 %>
                    <span class="food-macros">
                      P: <%= food.protein.round(1) %>g ‚Ä¢ C: <%= food.carbs.round(1) %>g ‚Ä¢ F: <%= food.fat.round(1) %>g
                    </span>
                  <% end %>
                </div>
              </div>
              <div class="food-actions">
                <button type="button" class="edit-btn" onclick="openEditModal(<%= food.id %>, '<%= j(food.name) %>', <%= food.calories %>, <%= food.protein %>, <%= food.fat %>, <%= food.carbs %>, <%= food.fiber %>, <%= food.sugar %>, <%= food.sodium %>)" title="Edit">‚úé</button>
                <button type="button" class="delete-btn" onclick="deleteFood(<%= food.id %>)" title="Delete">üóë</button>
              </div>
            </div>
          <% end %>
        <% end %>
      </div>

      <!-- Charts Section -->
      <% if @nutritional_totals[:calories] > 0 %>
        <div class="charts-section">
          <h3>üìä Nutritional Breakdown</h3>
          <div class="charts-grid">
            <div class="chart-container">
              <canvas id="macroChart"></canvas>
            </div>
            <div class="chart-container">
              <canvas id="nutritionChart"></canvas>
            </div>
          </div>
        </div>
      <% end %>
    </div>
  </div>

  <!-- Edit Food Modal -->
  <div id="editModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>‚úèÔ∏è Edit Food Entry</h2>
        <button type="button" class="modal-close" onclick="closeEditModal()">&times;</button>
      </div>
      <%= form_with model: @food || Food.new, url: foods_path, method: :patch, local: true, id: "edit-food-form", html: { style: "margin: 0;" } do |form| %>
        <div class="form-section" style="padding: 24px; border: none; box-shadow: none; margin: 0;">
          <div class="form-group">
            <%= form.label :name, "Food Name" %>
            <%= form.text_field :name, id: "edit-name", placeholder: "Food name...", required: true, autocomplete: "off" %>
          </div>
          <div class="nutritional-grid">
            <div class="form-group">
              <%= form.label :calories, "Calories" %>
              <%= form.number_field :calories, id: "edit-calories", placeholder: "0", min: 0, step: 0.1, required: true %>
            </div>
            <div class="form-group">
              <%= form.label :protein, "Protein (g)" %>
              <%= form.number_field :protein, id: "edit-protein", placeholder: "0", min: 0, step: 0.1, value: 0 %>
            </div>
            <div class="form-group">
              <%= form.label :carbs, "Carbs (g)" %>
              <%= form.number_field :carbs, id: "edit-carbs", placeholder: "0", min: 0, step: 0.1, value: 0 %>
            </div>
            <div class="form-group">
              <%= form.label :fat, "Fat (g)" %>
              <%= form.number_field :fat, id: "edit-fat", placeholder: "0", min: 0, step: 0.1, value: 0 %>
            </div>
            <div class="form-group">
              <%= form.label :fiber, "Fiber (g)" %>
              <%= form.number_field :fiber, id: "edit-fiber", placeholder: "0", min: 0, step: 0.1, value: 0 %>
            </div>
            <div class="form-group">
              <%= form.label :sugar, "Sugar (g)" %>
              <%= form.number_field :sugar, id: "edit-sugar", placeholder: "0", min: 0, step: 0.1, value: 0 %>
            </div>
            <div class="form-group">
              <%= form.label :sodium, "Sodium (mg)" %>
              <%= form.number_field :sodium, id: "edit-sodium", placeholder: "0", min: 0, step: 0.1, value: 0 %>
            </div>
          </div>
          <div class="form-actions">
            <%= form.submit "üíæ Update", class: "add-button" %>
          </div>
        </div>
      <% end %>
    </div>
  </div>

  <!-- Profile Modal (shown after registration if profile is complete) -->
  <% if @show_profile_modal %>
    <div id="profileModal" class="modal" style="display: block;">
      <div class="modal-content">
        <div class="modal-header">
          <h2>üéâ Welcome to SumLife!</h2>
          <button type="button" class="modal-close" onclick="closeProfileModal()">&times;</button>
        </div>
        <div style="padding: 24px;">
          <p style="margin-bottom: 24px; color: var(--gray-700);">Based on your profile, here's your personalized information:</p>
          
          <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 16px; margin-bottom: 24px;">
            <div style="background: var(--gray-50); padding: 20px; border-radius: 12px; border: 1px solid var(--gray-200);">
              <div style="font-size: 0.875rem; color: var(--gray-500); font-weight: 600; text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 8px;">BMI</div>
              <div style="font-size: 2rem; font-weight: 700; color: var(--gray-900);"><%= current_user.bmi %></div>
              <div style="font-size: 0.875rem; color: var(--gray-500); margin-top: 4px;"><%= current_user.bmi_category %></div>
            </div>
            <div style="background: var(--gray-50); padding: 20px; border-radius: 12px; border: 1px solid var(--gray-200);">
              <div style="font-size: 0.875rem; color: var(--gray-500); font-weight: 600; text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 8px;">Recommended Calories</div>
              <div style="font-size: 2rem; font-weight: 700; color: var(--gray-900);"><%= current_user.recommended_calories %></div>
              <div style="font-size: 0.875rem; color: var(--gray-500); margin-top: 4px;">per day</div>
            </div>
          </div>

          <div style="background: linear-gradient(135deg, rgba(99, 102, 241, 0.1) 0%, rgba(118, 75, 162, 0.1) 100%); padding: 16px; border-radius: 12px; margin-bottom: 24px;">
            <p style="margin: 0; color: var(--gray-700); font-size: 0.9375rem; line-height: 1.6;">
              <strong>Your Goal:</strong> <%= current_user.goal.humanize %> Weight<br>
              <strong>Activity Level:</strong> <%= current_user.activity_level.humanize %><br>
              <strong>BMR:</strong> <%= current_user.bmr.round %> calories/day (basal metabolic rate)<br>
              <strong>TDEE:</strong> <%= current_user.tdee.round %> calories/day (total daily energy expenditure)
            </p>
          </div>

          <button type="button" class="add-button" onclick="closeProfileModal()" style="width: 100%; margin-top: 0;">Got it!</button>
        </div>
      </div>
    </div>
    <% session.delete(:show_profile_modal) %>
  <% end %>

    <script>
    // Prevent page jump on form submit by preserving scroll position
    (function() {
      // Restore scroll position after page load (with small delay to ensure DOM is ready)
      window.addEventListener('load', function() {
        const scrollPos = sessionStorage.getItem('scrollPosition');
        if (scrollPos) {
          // Use requestAnimationFrame to ensure smooth scroll
          requestAnimationFrame(function() {
            window.scrollTo({
              top: parseInt(scrollPos),
              behavior: 'instant'
            });
            sessionStorage.removeItem('scrollPosition');
          });
        }
      });

      // Store scroll position before form submit and update hidden fields
      const form = document.getElementById('add-food-form');
      if (form) {
        form.addEventListener('submit', function(e) {
          // Update hidden fields with current quantity and unit
          const quantityInput = document.getElementById('quantity');
          const unitSelect = document.getElementById('quantity-unit-select');
          const formQuantity = document.getElementById('form-quantity');
          const formUnit = document.getElementById('form-unit');
          
          if (quantityInput && formQuantity) {
            formQuantity.value = quantityInput.value || 1;
          }
          if (unitSelect && formUnit) {
            formUnit.value = unitSelect.value || 'serving';
          }
          
          // Store current scroll position
          sessionStorage.setItem('scrollPosition', window.scrollY.toString());
        });
      }

      // Also store scroll position for delete buttons
      document.querySelectorAll('form[action*="/foods/"]').forEach(function(deleteForm) {
        deleteForm.addEventListener('submit', function() {
          sessionStorage.setItem('scrollPosition', window.scrollY.toString());
        });
      });
    })();

    // Quantity and nutritional calculation
      const nameInput = document.getElementById('name');
      const caloriesInput = document.getElementById('calories');
      const suggestionsDiv = document.getElementById('food-suggestions');
      let searchTimeout;
    let baseValues = {};

    // Function to calculate nutritional values based on quantity
    function calculateNutritionalValues() {
      if (!baseValues || Object.keys(baseValues).length === 0 || !baseValues.baseQuantity) {
        console.log('Base values not set:', baseValues);
        return;
      }
      
      const quantityInput = document.getElementById('quantity');
      const unitSelect = document.getElementById('quantity-unit-select');
      if (!quantityInput) return;
      
      const quantity = parseFloat(quantityInput.value) || baseValues.baseQuantity;
      const selectedUnit = unitSelect ? unitSelect.value : 'serving';
      
      // Calculate multiplier based on selected unit
      // baseValues are always per base_quantity
      let multiplier;
      if (selectedUnit === 'g' || selectedUnit === 'ml') {
        // User is entering grams or milliliters, base_quantity is in the same unit
        // For liquids, 1ml ‚âà 1g, so we can treat them the same
        multiplier = quantity / baseValues.baseQuantity;
      } else {
        // User is entering servings
        // If base_quantity = 100g/ml, then 1 serving = 100g/ml, so multiplier = quantity
        // If base_quantity = 1, then it's per serving, so multiplier = quantity / 1
        // For simplicity: if base_quantity >= 50, treat as grams/ml-based (1 serving = base_quantity)
        // Otherwise, treat as serving-based
        if (baseValues.baseQuantity >= 50) {
          // Base is in grams/ml (e.g., 100g or 250ml), so 1 serving = base_quantity
          multiplier = quantity; // quantity servings * base_quantity per serving / base_quantity = quantity
        } else {
          // Base is per serving (base_quantity = 1)
          multiplier = quantity / baseValues.baseQuantity;
        }
      }
      
      // Update all nutritional fields
      const caloriesEl = document.getElementById('calories');
      const proteinEl = document.getElementById('protein');
      const fatEl = document.getElementById('fat');
      const carbsEl = document.getElementById('carbs');
      const fiberEl = document.getElementById('fiber');
      const sugarEl = document.getElementById('sugar');
      const sodiumEl = document.getElementById('sodium');
      
      if (caloriesEl) caloriesEl.value = (baseValues.calories * multiplier).toFixed(1);
      if (proteinEl) proteinEl.value = (baseValues.protein * multiplier).toFixed(1);
      if (fatEl) fatEl.value = (baseValues.fat * multiplier).toFixed(1);
      if (carbsEl) carbsEl.value = (baseValues.carbs * multiplier).toFixed(1);
      if (fiberEl) fiberEl.value = (baseValues.fiber * multiplier).toFixed(1);
      if (sugarEl) sugarEl.value = (baseValues.sugar * multiplier).toFixed(1);
      if (sodiumEl) sodiumEl.value = (baseValues.sodium * multiplier).toFixed(1);
    }

    // Listen for quantity changes
    const quantityInput = document.getElementById('quantity');
    const unitSelect = document.getElementById('quantity-unit-select');
    let currentUnit = 'serving'; // Track current unit for conversion
    
    if (quantityInput) {
      quantityInput.addEventListener('input', calculateNutritionalValues);
      quantityInput.addEventListener('change', calculateNutritionalValues);
    }
    
    // Handle unit switching
    if (unitSelect) {
      unitSelect.addEventListener('change', function() {
        const newUnit = this.value;
        const quantity = parseFloat(quantityInput.value) || 1;
        
        if (!baseValues || Object.keys(baseValues).length === 0) {
          // No base values set, just update the unit
          currentUnit = newUnit;
          return;
        }
        
        // Convert quantity when switching units
        if (currentUnit === 'serving' && newUnit === 'g') {
          // Convert from serving to grams
          const convertedQuantity = quantity * baseValues.baseQuantity;
          quantityInput.value = convertedQuantity.toFixed(1);
        } else if (currentUnit === 'serving' && newUnit === 'ml') {
          // Convert from serving to milliliters (treat similar to grams for liquids)
          const convertedQuantity = quantity * baseValues.baseQuantity;
          quantityInput.value = convertedQuantity.toFixed(1);
        } else if (currentUnit === 'g' && newUnit === 'serving') {
          // Convert from grams to serving
          const convertedQuantity = quantity / baseValues.baseQuantity;
          quantityInput.value = convertedQuantity.toFixed(2);
        } else if (currentUnit === 'g' && newUnit === 'ml') {
          // Convert from grams to milliliters (1g ‚âà 1ml for water/liquids)
          quantityInput.value = quantity.toFixed(1);
        } else if (currentUnit === 'ml' && newUnit === 'serving') {
          // Convert from milliliters to serving
          const convertedQuantity = quantity / baseValues.baseQuantity;
          quantityInput.value = convertedQuantity.toFixed(2);
        } else if (currentUnit === 'ml' && newUnit === 'g') {
          // Convert from milliliters to grams (1ml ‚âà 1g for water/liquids)
          quantityInput.value = quantity.toFixed(1);
        }
        
        currentUnit = newUnit;
        calculateNutritionalValues();
      });
    }

      nameInput.addEventListener('input', function() {
        const query = this.value.trim();
        
        clearTimeout(searchTimeout);
        
        if (query.length < 2) {
          suggestionsDiv.style.display = 'none';
          return;
        }

        searchTimeout = setTimeout(() => {
          // Show loading indicator
          suggestionsDiv.innerHTML = '<div class="search-loading-text"><div class="search-loader"></div>Searching...</div>';
          suggestionsDiv.className = 'food-suggestions loading';
          suggestionsDiv.style.display = 'block';
          
        fetch(`/search_foods?q=${encodeURIComponent(query)}`, {
          method: 'GET',
          headers: {
            'X-CSRF-Token': document.querySelector('meta[name="csrf-token"]').content,
            'Accept': 'application/json',
            'X-Requested-With': 'XMLHttpRequest'
          },
          credentials: 'same-origin'
        })
          .then(response => {
            if (!response.ok) {
              throw new Error('Network response was not ok');
            }
            return response.json();
          })
            .then(foods => {
              if (foods.length === 0) {
                // If no results in database, try to fetch from external API
                if (query.length >= 3) {
                  suggestionsDiv.innerHTML = '<div class="search-loading-text"><div class="search-loader"></div>Fetching nutritional data...</div>';
                  fetchFoodDataFromAPI(query);
                  return;
                }
                // Show "no results" message for short queries
                suggestionsDiv.innerHTML = '<div class="no-results-message">No matches found. Try searching with 3+ characters to search online.</div>';
                suggestionsDiv.className = 'food-suggestions';
                suggestionsDiv.style.display = 'block';
                return;
              }
              
              // Remove loading class
              suggestionsDiv.className = 'food-suggestions';

              suggestionsDiv.innerHTML = foods.map(food => `
              <div class="food-suggestion-item" 
                   data-name="${food['name']}" 
                   data-calories="${food['calories_per_serving'] || 0}"
                   data-protein="${food['protein'] || 0}"
                   data-fat="${food['fat'] || 0}"
                   data-carbs="${food['carbs'] || 0}"
                   data-fiber="${food['fiber'] || 0}"
                   data-sugar="${food['sugar'] || 0}"
                   data-sodium="${food['sodium'] || 0}"
                   data-base-quantity="${food['base_quantity'] ? food['base_quantity'] : 1}"
                   data-serving-size="${food['serving_size'] || 'serving'}">
                  <div class="food-suggestion-name">${food['name']}</div>
                <div class="food-suggestion-details">${food['calories_per_serving']} calories ‚Ä¢ ${food['serving_size'] || 'per serving'}</div>
                </div>
              `).join('');

              suggestionsDiv.style.display = 'block';

              suggestionsDiv.querySelectorAll('.food-suggestion-item').forEach(item => {
                item.addEventListener('click', function() {
                  nameInput.value = this.dataset.name;
                  
                  // Store base values - access data attributes correctly
                  // Dataset API converts kebab-case to camelCase: data-base-quantity -> dataset.baseQuantity
                  const baseQty = parseFloat(this.dataset.baseQuantity) || 1;
                  
                  baseValues = {
                    calories: parseFloat(this.dataset.calories) || 0,
                    protein: parseFloat(this.dataset.protein) || 0,
                    fat: parseFloat(this.dataset.fat) || 0,
                    carbs: parseFloat(this.dataset.carbs) || 0,
                    fiber: parseFloat(this.dataset.fiber) || 0,
                    sugar: parseFloat(this.dataset.sugar) || 0,
                    sodium: parseFloat(this.dataset.sodium) || 0,
                    baseQuantity: baseQty,
                    servingSize: this.dataset.servingSize || 'serving'
                  };
                  
                  console.log('Base values set:', baseValues);
                  
                  // Set quantity to base quantity
                  const quantityInput = document.getElementById('quantity');
                  if (quantityInput) {
                    quantityInput.value = baseValues.baseQuantity;
                  }
                  
                  // Update unit display
                  const unitSelect = document.getElementById('quantity-unit-select');
                  const servingInfo = document.getElementById('base-serving-info');
                  
                  if (unitSelect && servingInfo) {
                    // Set the unit select based on base quantity and serving size
                    const servingSize = baseValues.servingSize || '';
                    if (servingSize.includes('ml') || servingSize.includes('mL') || servingSize.includes('milliliter')) {
                      unitSelect.value = 'ml';
                    } else if (baseValues.baseQuantity === 100) {
                      unitSelect.value = 'g';
                    } else {
                      unitSelect.value = 'serving';
                    }
                    servingInfo.textContent = `Base: ${baseValues.servingSize}`;
                    currentUnit = unitSelect.value;
                  }
                  
                  // Calculate and set values based on quantity
                  // Use setTimeout to ensure DOM is ready
                  setTimeout(() => {
                    calculateNutritionalValues();
                  }, 10);
                  
                  suggestionsDiv.style.display = 'none';
                });
              });
            })
            .catch(error => {
              console.error('Error searching foods:', error);
              suggestionsDiv.style.display = 'none';
              suggestionsDiv.className = 'food-suggestions';
            });
        }, 300);
      });

      document.addEventListener('click', function(e) {
        if (!nameInput.contains(e.target) && !suggestionsDiv.contains(e.target)) {
          suggestionsDiv.style.display = 'none';
        }
      });

    // Function to fetch food data from external API when not found in database
    function fetchFoodDataFromAPI(foodName) {
      if (foodName.length < 3) {
        suggestionsDiv.style.display = 'none';
        suggestionsDiv.className = 'food-suggestions';
        return;
      }
      
      fetch(`/fetch_food_data?name=${encodeURIComponent(foodName)}`, {
        method: 'GET',
        headers: {
          'X-CSRF-Token': document.querySelector('meta[name="csrf-token"]').content,
          'Accept': 'application/json',
          'X-Requested-With': 'XMLHttpRequest'
        },
        credentials: 'same-origin'
      })
        .then(response => {
          if (!response.ok) {
            return response.json().then(data => {
              throw new Error(data.error || 'Failed to fetch food data');
            });
          }
          return response.json();
        })
        .then(foodData => {
          // Check if we got an error or no data
          if (foodData.error || !foodData.name) {
            // Show "no results" message
            suggestionsDiv.innerHTML = '<div class="no-results-message">No nutritional data found. You can still enter this food manually.</div>';
            suggestionsDiv.className = 'food-suggestions';
            suggestionsDiv.style.display = 'block';
            return;
          }
          
          // Hide suggestions if we got valid data (it will auto-populate)
          suggestionsDiv.style.display = 'none';
          suggestionsDiv.className = 'food-suggestions';
          
          // Auto-populate form fields with fetched data
          if (foodData.name && nameInput.value.trim().toLowerCase() === foodName.toLowerCase()) {
            // Set base values - use API serving size or default to 100g
            const baseQty = foodData.base_quantity || 100;
            const servingSize = foodData.serving_size || '100g';
            
            baseValues = {
              calories: foodData.calories || 0,
              protein: foodData.protein || 0,
              fat: foodData.fat || 0,
              carbs: foodData.carbs || 0,
              fiber: foodData.fiber || 0,
              sugar: foodData.sugar || 0,
              sodium: foodData.sodium || 0,
              baseQuantity: baseQty,
              servingSize: servingSize
            };
            
            // Set quantity to base quantity
            const quantityInput = document.getElementById('quantity');
            if (quantityInput) {
              quantityInput.value = baseQty;
            }
            
            // Update unit display based on serving size
            const unitSelect = document.getElementById('quantity-unit-select');
            const servingInfo = document.getElementById('base-serving-info');
            
            if (unitSelect && servingInfo) {
              // Parse serving size to determine unit
              if (servingSize.includes('ml') || servingSize.includes('mL') || servingSize.includes('milliliter')) {
                unitSelect.value = 'ml';
                servingInfo.textContent = `Base: ${servingSize}`;
              } else if (servingSize.includes('g') && baseQty === 100) {
                unitSelect.value = 'g';
                servingInfo.textContent = `Base: ${servingSize}`;
              } else if (servingSize.includes('oz')) {
                unitSelect.value = 'g'; // Use grams for oz-based foods
                servingInfo.textContent = `Base: ${servingSize}`;
              } else if (servingSize.includes('cup')) {
                unitSelect.value = 'serving';
                servingInfo.textContent = `Base: ${servingSize}`;
              } else if (servingSize.includes('serving') || servingSize.includes('piece') || servingSize.includes('slice')) {
                unitSelect.value = 'serving';
                servingInfo.textContent = `Base: ${servingSize}`;
              } else {
                // Default to grams if base quantity is 100, otherwise use serving
                if (baseQty === 100) {
                  unitSelect.value = 'g';
                  servingInfo.textContent = `Base: ${servingSize}`;
                } else {
                  unitSelect.value = 'serving';
                  servingInfo.textContent = `Base: ${servingSize}`;
                }
              }
              currentUnit = unitSelect.value;
            }
            
            // Calculate and populate nutritional values
            setTimeout(() => {
              calculateNutritionalValues();
            }, 10);
          }
        })
        .catch(error => {
          // Show "no results" message on error
          suggestionsDiv.innerHTML = '<div class="no-results-message">Could not fetch nutritional data. You can still enter this food manually.</div>';
          suggestionsDiv.className = 'food-suggestions';
          suggestionsDiv.style.display = 'block';
          console.log('Could not fetch food data:', error.message);
        });
    }

    // Auto-fetch when user leaves the input field and food is not in database
    let fetchTimeout;
    nameInput.addEventListener('blur', function() {
      const query = this.value.trim();
      if (query.length >= 3) {
        clearTimeout(fetchTimeout);
        fetchTimeout = setTimeout(() => {
          // Check if it's in our database first
          fetch(`/search_foods?q=${encodeURIComponent(query)}`, {
            method: 'GET',
            headers: {
              'X-CSRF-Token': document.querySelector('meta[name="csrf-token"]').content,
              'Accept': 'application/json',
              'X-Requested-With': 'XMLHttpRequest'
            },
            credentials: 'same-origin'
          })
            .then(response => response.json())
            .then(foods => {
              // Only fetch from API if not found in database and no base values set
              if (foods.length === 0 && (!baseValues || Object.keys(baseValues).length === 0)) {
                fetchFoodDataFromAPI(query);
              }
            })
            .catch(() => {
              // If search fails, try API anyway
              if (!baseValues || Object.keys(baseValues).length === 0) {
                fetchFoodDataFromAPI(query);
              }
            });
        }, 500);
      }
    });

    // Edit Modal Functions
    function openEditModal(foodId, name, calories, protein, fat, carbs, fiber, sugar, sodium) {
      const modal = document.getElementById('editModal');
      const form = document.getElementById('edit-food-form');
      
      // Update form action URL with the food ID
      form.action = `/foods/${foodId}`;
      
      // Ensure method is PATCH
      const methodInput = form.querySelector('input[name="_method"]');
      if (methodInput) {
        methodInput.value = 'patch';
      } else {
        const hiddenInput = document.createElement('input');
        hiddenInput.type = 'hidden';
        hiddenInput.name = '_method';
        hiddenInput.value = 'patch';
        form.appendChild(hiddenInput);
      }
      
      // Populate form fields
      document.getElementById('edit-name').value = name;
      document.getElementById('edit-calories').value = calories;
      document.getElementById('edit-protein').value = protein;
      document.getElementById('edit-fat').value = fat;
      document.getElementById('edit-carbs').value = carbs;
      document.getElementById('edit-fiber').value = fiber;
      document.getElementById('edit-sugar').value = sugar;
      document.getElementById('edit-sodium').value = sodium;
      
      // Show modal
      modal.style.display = 'block';
      document.body.style.overflow = 'hidden';
    }

    function closeEditModal() {
      const modal = document.getElementById('editModal');
      modal.style.display = 'none';
      document.body.style.overflow = 'auto';
    }

    function deleteFood(foodId) {
      if (confirm('Are you sure you want to delete this food entry?')) {
        // Create a form to submit DELETE request
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = `/foods/${foodId}`;
        
        // Add CSRF token
        const csrfToken = document.querySelector('meta[name="csrf-token"]').content;
        const csrfInput = document.createElement('input');
        csrfInput.type = 'hidden';
        csrfInput.name = 'authenticity_token';
        csrfInput.value = csrfToken;
        form.appendChild(csrfInput);
        
        // Add method override for DELETE
        const methodInput = document.createElement('input');
        methodInput.type = 'hidden';
        methodInput.name = '_method';
        methodInput.value = 'delete';
        form.appendChild(methodInput);
        
        // Store scroll position
        sessionStorage.setItem('scrollPosition', window.scrollY.toString());
        
        // Submit form
        document.body.appendChild(form);
        form.submit();
      }
    }

    function closeProfileModal() {
      const modal = document.getElementById('profileModal');
      if (modal) {
        modal.style.display = 'none';
        document.body.style.overflow = 'auto';
      }
    }

    // Close modal when clicking outside of it
    window.onclick = function(event) {
      const editModal = document.getElementById('editModal');
      const profileModal = document.getElementById('profileModal');
      if (event.target === editModal) {
        closeEditModal();
      }
      if (event.target === profileModal) {
        closeProfileModal();
      }
    }

    // Close modal on Escape key
    document.addEventListener('keydown', function(event) {
      if (event.key === 'Escape') {
        closeEditModal();
        closeProfileModal();
      }
    });

    // Store scroll position before edit form submit
    const editForm = document.getElementById('edit-food-form');
    if (editForm) {
      editForm.addEventListener('submit', function() {
        sessionStorage.setItem('scrollPosition', window.scrollY.toString());
      });
    }

    // Date picker handler
    const datePicker = document.getElementById('date-picker');
    if (datePicker) {
      datePicker.addEventListener('change', function() {
        const selectedDate = this.value;
        window.location.href = `/?date=${selectedDate}`;
      });
    }

    // Initialize charts if they exist
    <% if @nutritional_totals[:calories] > 0 %>
    const macroCtx = document.getElementById('macroChart');
    const nutritionCtx = document.getElementById('nutritionChart');
    
    if (macroCtx) {
      new Chart(macroCtx, {
        type: 'doughnut',
        data: {
          labels: ['Protein', 'Carbs', 'Fat'],
          datasets: [{
            data: [
              <%= (@nutritional_totals[:protein] * 4).round(1) %>,
              <%= (@nutritional_totals[:carbs] * 4).round(1) %>,
              <%= (@nutritional_totals[:fat] * 9).round(1) %>
            ],
            backgroundColor: [
              'rgba(99, 102, 241, 0.8)',
              'rgba(16, 185, 129, 0.8)',
              'rgba(245, 158, 11, 0.8)'
            ],
            borderWidth: 0
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              position: 'bottom',
              labels: {
                padding: 15,
                font: {
                  size: 12,
                  weight: '600'
                }
              }
            },
            title: {
              display: true,
              text: 'Macros (by calories)',
              font: {
                size: 14,
                weight: '700'
              },
              padding: {
                bottom: 10
              }
            }
          }
        }
      });
    }

    if (nutritionCtx) {
      new Chart(nutritionCtx, {
        type: 'bar',
        data: {
          labels: ['Fiber (g)', 'Sugar (g)', 'Sodium (mg/100)'],
          datasets: [{
            label: 'Amount',
            data: [
              <%= @nutritional_totals[:fiber].round(1) %>,
              <%= @nutritional_totals[:sugar].round(1) %>,
              <%= (@nutritional_totals[:sodium] / 100).round(1) %>
            ],
            backgroundColor: [
              'rgba(147, 51, 234, 0.8)',  // Purple for Fiber
              'rgba(236, 72, 153, 0.8)',  // Pink for Sugar
              'rgba(20, 184, 166, 0.8)'   // Teal for Sodium
            ],
            borderRadius: 8
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              display: false
            },
            title: {
              display: true,
              text: 'Other Nutrients',
              font: {
                size: 14,
                weight: '700'
              },
              padding: {
                bottom: 10
              }
            }
          },
          scales: {
            y: {
              beginAtZero: true,
              ticks: {
                font: {
                  size: 11
                }
              }
            },
            x: {
              ticks: {
                font: {
                  size: 11,
                  weight: '600'
                }
              }
            }
          }
        }
      });
    }
        <% end %>

    // Health score color coding
    const healthScoreEl = document.querySelector('.health-score-value');
    if (healthScoreEl) {
      const score = parseInt(healthScoreEl.dataset.score);
      if (score >= 80) {
        healthScoreEl.style.color = '#10b981';
      } else if (score >= 60) {
        healthScoreEl.style.color = '#f59e0b';
      } else {
        healthScoreEl.style.color = '#ef4444';
      }
    }
  </script>
</body>
</html>
